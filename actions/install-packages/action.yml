name: 'Install packages'
description: 'Install listed packages using brew or apt'

inputs:
  packages:
    description: 'List of package names'
    required: true

runs:
  using: 'composite'
  steps:
    - name: Install packages (Linux)
      if: runner.os == 'Linux'
      shell: bash
      run: |
        sudo apt-get update
        sudo apt-get install -y ${{ inputs.packages }}

    - name: Install packages (macOS)
      if: runner.os == 'macOS'
      shell: bash
      run: |
        requested_packages="$(echo "${{ inputs.packages }}" \
          | sed 's/[[:space:]]\+/\n/g' | sed '/^$/d' | sed '$a\')"
        echo \
          "Requested packages: [$(echo "$requested_packages" | tr '\n' ' ')]"

        installed_packages="$(brew list)"
        echo \
          "Installed packages: [$(echo "$installed_packages" | tr '\n' ' ')]"

        missing_packages="$(echo "$requested_packages" \
          | grep -v -f <(echo "$installed_packages"))"
        echo \
          "Missing packages: [$(echo "$missing_packages" | tr '\n' ' ')]"

        if [ -n "$missing_packages" ]; then
          set -x
          brew install $(echo "$missing_packages" | tr '\n' ' ')
        else
          echo "All requested packages already installed"
        fi
